// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// 1. สินค้า (เมนู)
model Product {
  id          String   @id @default(uuid()) // ใช้ UUID เพื่อความ Pro และปลอดภัย
  code        String   @unique // รหัสสินค้า (เช่น C001, B002)
  name        String
  category    String   // Coffee, Non-Coffee, Bakery
  price       Decimal  // ราคาพื้นฐาน
  image_url   String?  // รูปภาพ (ถ้ามี)
  is_active   Boolean  @default(true) // ปิดเมนูเมื่อของหมด
  stock       Int      @default(0)
  
  // Relation
  orderItems  OrderItem[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("products")
}

// 2. ลูกค้า (CRM Simple)
model Customer {
  id          String   @id @default(uuid())
  phone       String   @unique // ใช้เบอร์โทรเป็นหลัก
  name        String?  // ชื่อเล่น (ถ้าลูกค้าบอก)
  points      Int      @default(0) // แต้มสะสม
  total_spent Decimal  @default(0) // ยอดรวมที่เคยจ่าย (ไว้คัด VIP)
  
  // Relation
  orders      Order[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("customers")
}

// 3. ออเดอร์ (Head)
model Order {
  id            String    @id @default(uuid())
  total_amount  Decimal   
  payment_type  String    @default("QR") // QR, CASH
  status        String    @default("PENDING") // PENDING, PAID, CANCELLED
  order_type    String    @default("DINE_IN") // DINE_IN, TAKE_AWAY
  
  // เชื่อมกับลูกค้า (Optional เพราะบางคนอาจไม่เป็นสมาชิก)
  customer_id   String?
  customer      Customer? @relation(fields: [customer_id], references: [id])
  
  // รายการสินค้าในบิล
  items         OrderItem[]

  createdAt     DateTime  @default(now())
  
  @@map("orders")
}

// 4. รายการในออเดอร์ (Line Items)
model OrderItem {
  id          String   @id @default(uuid())
  order_id    String
  order       Order    @relation(fields: [order_id], references: [id])
  
  product_id  String
  product     Product  @relation(fields: [product_id], references: [id])
  
  name        String   // Snapshot ชื่อตอนสั่ง (กันเมนูเปลี่ยนชื่อ)
  price       Decimal  // Snapshot ราคาตอนสั่ง
  quantity    Int
  
  // *** ทีเด็ด: เก็บ Option หวาน/เย็น/เพิ่มช็อต เป็น JSON ***
  // ตัวอย่าง: { "sweetness": "50%", "type": "iced", "extra": ["shot"] }
  // หมายเหตุ: ถ้าใช้ SQLite เปลี่ยนเป็น String แล้ว JSON.stringify เอาแทนได้
  options     String?  
  
  @@map("order_items")
}
// 5. ผู้ใช้งานระบบ (Admin/Staff)
model User {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String   // เก็บแบบ Hash
  name      String?
  role      String   @default("STAFF") // ADMIN, STAFF
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 6. การตั้งค่าร้าน
model StoreSettings {
  id          String   @id @default("default")
  store_name  String   @default("Pocket Café")
  store_logo  String?  // URL ของโลโก้
  address     String?
  phone       String?
  tax_id      String?  // เลขประจำตัวผู้เสียภาษี
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("store_settings")
}

// 7. Feature Flags (เปิด/ปิด features สำหรับขาย addon)
model FeatureFlag {
  id          String   @id @default(uuid())
  name        String   @unique
  enabled     Boolean  @default(false)
  description String?
  is_addon    Boolean  @default(false) // ถ้าเป็น addon จะแสดงปุ่มซื้อ
  
  @@map("feature_flags")
}